version: '3.8'

services:
  # --- INFRASTRUCTURE SERVICES ---

  db:
    image: postgres:18-alpine
    container_name: happydonut-db
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d # <--- AÑADIDO PARA INICIALIZAR LA DB
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - POSTGRES_DB=happydonut_db # Puedes mantener una DB por defecto si quieres
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-happydonut_db}"] # Usa la variable o un valor por defecto
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: happydonut-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- APPLICATION SERVICES (Microservices) ---

  # 1. API Gateway with Nginx
  api-gateway-nginx:
    image: nginx:1.25-alpine
    container_name: api-gateway-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./apigateway:/var/www
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - happydonut-net

  api-gateway:
    build:
      context: ./apigateway
      dockerfile: Dockerfile
    container_name: api-gateway-app
    restart: unless-stopped
    volumes:
      - ./apigateway:/var/www
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local  # Cambiado a local para desarrollo
      - APP_DEBUG=true # Cambiado a true para desarrollo
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_NAME_API_GATEWAY} # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file # O redis si lo configuras
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    networks:
      - happydonut-net
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 2. Authentication Service
  auth-service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    container_name: auth-service-app
    restart: unless-stopped
    volumes:
      - ./auth_service:/var/www
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_NAME_AUTH} # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
    networks:
      - happydonut-net
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. Product Service
  product-service:
    build:
      context: ./product_service
      dockerfile: Dockerfile
    container_name: product-service-app
    restart: unless-stopped
    volumes:
      - ./product_service:/var/www
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_NAME_PRODUCT} # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
    networks:
      - happydonut-net
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 4. Inventory Service
  inventory-service:
    build:
      context: ./inventory_service
      dockerfile: Dockerfile
    container_name: inventory-service-app
    restart: unless-stopped
    volumes:
      - ./inventory_service:/var/www
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_NAME_INVENTORY} # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
    networks:
      - happydonut-net
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 5. Order Service
  order-service:
    build:
      context: ./order_service
      dockerfile: Dockerfile
    container_name: order-service-app
    restart: unless-stopped
    volumes:
      - ./order_service:/var/www
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_NAME_ORDER} # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    networks:
      - happydonut-net
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 6. Email Service
  email-service:
    build:
      context: ./email_service
      dockerfile: Dockerfile
    container_name: email-service-app
    restart: unless-stopped
    volumes:
      - ./email_service:/var/www
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql # Asumiendo que necesita DB para logs
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=${DB_NAME_EMAIL} # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    networks:
      - happydonut-net
    depends_on:
      rabbitmq:
        condition: service_healthy
      # db: # Descomentar si realmente usa la DB
      #  condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

# --- VOLUMES AND NETWORKS ---

volumes:
  db-data:
  rabbitmq-data:

networks:
  happydonut-net:
    driver: bridge