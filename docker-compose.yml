

services:

  # -----------------------------------------------------------------
  # 1. SERVIDORES DE BASE DE DATOS DEDICADOS (1 por Microservicio)
  # -----------------------------------------------------------------

  db-auth:
    image: postgres:18-alpine
    container_name: happydonut-db-auth
    restart: unless-stopped
    # Nota: No mapeamos puertos para evitar conflictos; la comunicación es interna.
    volumes:
      - db-auth-data:/var/lib/postgresql/data # Volumen dedicado
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=auth_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5440:5432"  # Puerto mapeado solo para acceso externo si es necesario

  db-product:
    image: postgres:18-alpine
    container_name: happydonut-db-product
    restart: unless-stopped
    volumes:
      - db-product-data:/var/lib/postgresql/data # Volumen dedicado
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=product_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d product_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5441:5432"

  db-inventory:
    image: postgres:18-alpine
    container_name: happydonut-db-inventory
    restart: unless-stopped
    volumes:
      - db-inventory-data:/var/lib/postgresql/data # Volumen dedicado
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=inventory_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d inventory_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5442:5432"

  db-order:
    image: postgres:18-alpine
    container_name: happydonut-db-order
    restart: unless-stopped
    volumes:
      - db-order-data:/var/lib/postgresql/data # Volumen dedicado
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=order_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d order_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5443:5432"

  db-email:
    image: postgres:18-alpine
    container_name: happydonut-db-email
    restart: unless-stopped
    volumes:
      - db-email-data:/var/lib/postgresql/data # Volumen dedicado
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=email_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d email_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5444:5432"

  db-apigateway:
    image: postgres:18-alpine
    container_name: happydonut-db-apigateway
    restart: unless-stopped
    volumes:
      - db-apigateway-data:/var/lib/postgresql/data # Volumen dedicado
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=apigateway_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - happydonut-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d apigateway_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5445:5432"

  # --- APPLICATION SERVICES (Microservices) ---

  # 1. API Gateway with Nginx
  api-gateway-nginx:
    image: nginx:1.25-alpine
    container_name: api-gateway-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./apigateway:/var/www
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - happydonut-net
    
  api-gateway:
    build:
      context: ./apigateway
      dockerfile: Dockerfile
    container_name: api-gateway-app
    restart: unless-stopped
    ports:
      - "8000:8000"  
    volumes:
      - ./apigateway:/var/www
      - /var/www/vendor # <--- OJO EN CASO LO NECESIES, SINO QUITALO
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local  # Cambiado a local para desarrollo
      - APP_DEBUG=true # Cambiado a true para desarrollo
      - DB_CONNECTION=pgsql
      - DB_HOST=db-apigateway
      - DB_PORT=5432
      - DB_DATABASE=apigateway_db # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file # O redis si lo configuras
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    networks:
      - happydonut-net
    depends_on:
        db-apigateway:
          condition: service_healthy
        auth-service:                    # ← AGREGA ESTO
          condition: service_healthy
        product-service:
          condition: service_healthy
        inventory-service:
          condition: service_healthy
        order-service:
          condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 2. Authentication Service
  auth-service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    container_name: auth-service-app
    restart: unless-stopped
    ports:
      - "9001:8000"
    volumes:
      - ./auth_service:/var/www
      - /var/www/vendor
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db-auth
      - DB_PORT=5432
      - DB_DATABASE=auth_db 
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
    networks:
      - happydonut-net
    depends_on:
      db-auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. Product Service
  product-service:
    build:
      context: ./product_service
      dockerfile: Dockerfile
    container_name: product-service-app
    restart: unless-stopped
    ports:
      - "9002:8000"
    volumes:
      - ./product_service:/var/www
      - /var/www/vendor
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db-product
      - DB_PORT=5432
      - DB_DATABASE=product_db # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
    networks:
      - happydonut-net
    depends_on:
      db-product:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 4. Inventory Service
  inventory-service:
    build:
      context: ./inventory_service
      dockerfile: Dockerfile
    container_name: inventory-service-app
    restart: unless-stopped
    ports:
      - "9003:8000"
    volumes:
      - ./inventory_service:/var/www
      - /var/www/vendor
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db-inventory
      - DB_PORT=5432
      - DB_DATABASE=inventory_db # Base de datos específica
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
    networks:
      - happydonut-net
    depends_on:
      db-inventory:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 5. Order Service
  order-service:
    build:
      context: ./order_service
      dockerfile: Dockerfile
    container_name: order-service-app
    restart: unless-stopped
    ports:
      - "9004:8000"
    volumes:
      - ./order_service:/var/www
      - /var/www/vendor
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql
      - DB_HOST=db-order
      - DB_PORT=5432
      - DB_DATABASE=order_db
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    networks:
      - happydonut-net
    depends_on:
      db-order:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 6. Email Service
  email-service:
    build:
      context: ./email_service
      dockerfile: Dockerfile
    container_name: email-service-app
    restart: unless-stopped
    ports:
      - "9005:8000"
    volumes:
      - ./email_service:/var/www
      - /var/www/vendor
    env_file:    # <--- LEE EL ARCHIVO .env DE LA RAÍZ
      - ./.env
    environment: # <--- USA LAS VARIABLES DEL .env
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=pgsql # Asumiendo que necesita DB para logs
      - DB_HOST=db-email
      - DB_PORT=5432
      - DB_DATABASE=email_db
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - CACHE_DRIVER=file
      - QUEUE_CONNECTION=rabbitmq
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    networks:
      - happydonut-net
    depends_on:
      db-email:
        condition: service_healthy
      # db: # Descomentar si realmente usa la DB
      #  condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  # 7. Frontend Clientes (CRA - npm start)
  # Se servirá en el puerto 3000 interno
  frontend-clientes:
    build:
      context: ./frontend-clientes  # Asegúrate que el nombre de carpeta coincida
      dockerfile: Dockerfile
    container_name: frontend-clientes-app
    restart: unless-stopped
    volumes:
      - ./frontend-clientes:/app
      - /app/node_modules
    ports:
      - "3000:3000" # Acceso directo si Nginx falla
    environment:
      - PORT=3000
      - CHOKIDAR_USEPOLLING=true
      - WDS_SOCKET_PORT=0
    networks:
      - happydonut-net

  # 8. Frontend Administrativo (Vite - npm run dev)
  # Se servirá en el puerto 5173 interno
  frontend-administrativo:
    build:
      context: ./frontend-administrativo # Asegúrate que el nombre de carpeta coincida
      dockerfile: Dockerfile
    container_name: frontend-administrativo-app
    restart: unless-stopped
    volumes:
      - ./frontend-administrativo:/app
      - /app/node_modules
    ports:
      - "5173:5173" # Acceso directo si Nginx falla
    environment:
      - VITE_PORT=5173
    networks:
      - happydonut-net

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: happydonut-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # Puerto para comunicación entre apps
      - "15672:15672" # Panel de administración web (http://localhost:15672)
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - happydonut-net

# --- VOLUMES AND NETWORKS ---

volumes:
  db-auth-data: 
  db-product-data:
  db-inventory-data:
  db-order-data:
  db-email-data:
  db-apigateway-data:
  rabbitmq-data:

networks:
  happydonut-net:
    driver: bridge