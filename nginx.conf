server {
    listen 80;
    server_name localhost;
    root /var/www/public;
    index index.php index.html;

    # --------------------------------------------------------
    # 1. REGLA DE ENRUTAMIENTO DIRECTO A MICROSERVICIO DE AUTH
    # Intercepta todas las peticiones que empiezan por /api/auth/
    # y las envía al contenedor 'auth-service'.
    # --------------------------------------------------------
    location /api/auth/ {
        # Esta línea es CRÍTICA: elimina el prefijo '/api/auth/'
        # para que el microservicio Auth solo vea '/login' o '/register'.
        rewrite ^/api/auth/(.*)$ /$1 break;
        
        # Redirige el tráfico al contenedor del microservicio de autenticación
        proxy_pass http://auth-service:8000;
        
        # Configuración de cabeceras de proxy estándar
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # --------------------------------------------------------
    # 2. LÓGICA LARAVEL/PHP-FPM EXISTENTE (Para el API Gateway principal)
    # --------------------------------------------------------
    
    # Maneja rutas que no son archivos estáticos (Laravel)
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Pasa todas las solicitudes PHP al contenedor FPM del API Gateway
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # Pasa la petición al contenedor del API Gateway (tu app Laravel/Lumen)
        fastcgi_pass api-gateway-app:9000;
        
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # Bloqueo de archivos .ht
    location ~ /\.ht {
        deny all;
    }
}